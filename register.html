<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Register for Courses</title>
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body>
    <div class="page">
      <main class="card">
        <h1>Register for Courses</h1>
        <p id="who" class="muted"></p>

        <div class="form-inline" style="margin-top: 12px">
          <label style="flex: 1"
            >Search<input id="q" placeholder="Search by course name or code"
          /></label>
          <label style="width: 160px"
            >Filter by
            <select id="searchMode">
              <option value="text">Name or Code</option>
              <option value="credits">Credit Hours</option>
            </select>
          </label>
          <label style="width: 160px" id="creditsFilterLabel" hidden
            >Credit Hours
            <input
              id="creditVal"
              type="number"
              min="1"
              max="6"
              placeholder="3"
            />
          </label>
          <div class="controls">
            <button id="search">Search</button>
          </div>
        </div>

        <h2>Search Results</h2>
        <div id="results" class="list muted"></div>

        <hr style="margin: 16px 0" />
        <h2>Your Current Registrations</h2>
        <div id="myRegs" class="list muted"></div>

        <hr style="margin: 16px 0" />
        <h2>Switch Courses</h2>
        <div class="form-inline">
          <label
            >Drop course (code)<input id="dropCode" placeholder="CSE101"
          /></label>
          <label
            >Add course (code)<input id="pickCode" placeholder="MTH100"
          /></label>
          <label
            >Payment method
            <select id="exchangeMethod">
              <option>Visa</option>
              <option>Cash</option>
            </select>
          </label>
          <div class="controls"><button id="exchangeBtn">Switch</button></div>
        </div>
      </main>
    </div>

    <script src="assets/app.js"></script>
    <script>
      UMSApp.requireAuth();
      const user = UMSApp.currentUser();
      document.getElementById("who").textContent = `${user.username}`;
      if (user.role !== "student") {
        document.getElementById("results").textContent =
          "Login as a student to register for courses.";
      }

      function renderResults(list) {
        const html = list
          .map(
            (
              c
            ) => `<div class="row"><div><strong>${c.code}</strong> ${c.title} <div class="small">${c.credits} credits • ${c.seats} seats available</div></div>
        <div class="controls"><label>Payment<select class="payMethod"><option>Visa</option><option>Cash</option></select></label><button data-code="${c.code}" class="reg">Register</button></div></div>`
          )
          .join("");
        document.getElementById("results").innerHTML =
          html || "<em>No courses found.</em>";
        document.querySelectorAll(".reg").forEach((b) =>
          b.addEventListener("click", () => {
            const code = b.getAttribute("data-code");
            const sel = b.parentElement.querySelector(".payMethod");
            const method = sel ? sel.value : "Visa";
            try {
              const count = UMSApp.countStudentCourses(user.username);
              if (count >= 7)
                return alert("You have reached the maximum of 7 courses.");
              const res = UMSApp.registerCourse(user.username, code, method);
              renderMyRegs();
              alert("Registration successful");
            } catch (err) {
              if (err.message === "full")
                alert("This course is full. No seats available.");
              else if (err.message === "payment_failed") {
                if (confirm("Payment failed. Try again?")) b.click();
              } else if (err.message === "max_reached")
                alert("You have reached your course limit.");
              else alert("Error: " + err.message);
            }
          })
        );
      }

      function renderMyRegs() {
        const regs = UMSApp.studentRegistrations(user.username);
        const payments = UMSApp.getPaymentsForStudent
          ? UMSApp.getPaymentsForStudent(user.username)
          : [];
        const frag = regs
          .map((r) => {
            const pay = payments.find((p) => p.regId === r.regId);
            const payLabel = pay ? ` • ${pay.method} (${pay.status})` : "";
            const dropBtn = `<button data-code="${r.course}" class="dropBtn ghost">Drop</button>`;
            return `<div class="row"><div><strong>${r.course}</strong> (${r.status})${payLabel}</div><div>${dropBtn}</div></div>`;
          })
          .join("");
        document.getElementById("myRegs").innerHTML =
          frag || "<em>No registrations yet.</em>";
        document.querySelectorAll(".dropBtn").forEach((b) =>
          b.addEventListener("click", () => {
            const code = b.getAttribute("data-code");
            if (confirm("Drop this course?")) {
              try {
                UMSApp.dropCourse(user.username, code);
                renderMyRegs();
                alert("Course dropped");
              } catch (e) {
                alert(e.message);
              }
            }
          })
        );
        const count = UMSApp.countStudentCourses(user.username);
        if (count < 4)
          document
            .getElementById("myRegs")
            .insertAdjacentHTML(
              "afterbegin",
              `<div class="error small">Recommendation: Register for at least 4 courses to maintain full-time status.</div>`
            );
      }

      document.getElementById("search").addEventListener("click", () => {
        const mode = document.getElementById("searchMode").value;
        const q = document.getElementById("q").value.trim();
        if (mode === "credits") {
          const v = document.getElementById("creditVal").value;
          const res = UMSApp.searchCourses("", {
            by: "credits",
            value: Number(v),
          });
          renderResults(res);
        } else {
          const res = UMSApp.searchCourses(q);
          renderResults(res);
        }
      });

      document.getElementById("searchMode").addEventListener("change", (e) => {
        const v = e.target.value;
        document.getElementById("creditsFilterLabel").hidden = v !== "credits";
      });

      document.getElementById("exchangeBtn").addEventListener("click", () => {
        const drop = document.getElementById("dropCode").value.trim();
        const pick = document.getElementById("pickCode").value.trim();
        const method = document.getElementById("exchangeMethod").value;
        if (!drop || !pick) return alert("Enter both course codes.");
        try {
          UMSApp.exchangeCourse(user.username, drop, pick, method);
          renderMyRegs();
          alert("Course switch successful");
        } catch (err) {
          if (err.message === "new_full") alert("The target course is full.");
          else if (err.message === "payment_failed")
            alert("Payment failed during switch.");
          else alert("Error: " + err.message);
        }
      });

      const params = new URLSearchParams(location.search);
      if (params.has("course")) {
        const code = params.get("course");
        const c = UMSApp.findCourse(code);
        if (c) renderResults([c]);
      }
      renderMyRegs();
    </script>
  </body>
</html>
